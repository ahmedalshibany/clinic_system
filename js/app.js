const translations = {
    en: {
        appTitle: "Clinic System",
        loginTitle: "Welcome Back",
        loginSubtitle: "Sign in to access your dashboard",
        emailLabel: "Email Address",
        passwordLabel: "Password",
        loginBtn: "Login",
        dashboard: "Dashboard",
        patients: "Patients",
        appointments: "Appointments",
        doctors: "Doctors",
        settings: "Settings",
        logout: "Logout",
        totalPatients: "Total Patients",
        todayAppts: "Today's Appointments",
        totalDoctors: "Total Doctors",
        addPatient: "Add Patient",
        fullName: "Full Name",
        age: "Age",
        phone: "Phone Number",
        gender: "Gender",
        male: "Male",
        female: "Female",
        address: "Address",
        submit: "Submit",
        save: "Save Changes",
        bookAppt: "Book Appointment",
        doctorName: "Doctor Name",
        date: "Date",
        time: "Time",
        status: "Status",
        pending: "Pending",
        confirmed: "Confirmed",
        completed: "Completed",
        specialty: "Specialty",
        workingDays: "Working Days",
        changeUser: "Change Username",
        changePass: "Change Password",
        newUsername: "New Username",
        newPassword: "New Password",
        loginSuccess: "Login Successful! Redirecting...",
        validationError: "Please fill in all fields.",
        genericSuccess: "Action completed successfully!",
        langBtn: "العربية",
        welcomeDr: "Welcome, Dr. Smith",
        recentPatients: "Recent Patients",
        patientName: "Patient Name",
        actions: "Actions",
        view: "View",
        incomingPatientHistory: "Incoming Patient History",
        weekly: "Weekly",
        monthly: "Monthly",
        yearly: "Yearly",
        consultation: "CONSULTATION",
        inProgress: "IN PROGRESS",
        inReview: "IN REVIEW",
        inPending: "IN PENDING",
        goodMorning: "Good Morning!",
        doctorName2: "Dr. John Jacob",
        specialization: "Orthopedical",
        bookingRate: "Booking Rate",
        yourTotalPatient: "Your Total Patient",
        onFriday: "on Friday",
        bookingHigher: "Your booking is higher than yesterday",
        yourPatientsToday: "Your Patients Today",
        mySchedule: "My Schedule",
        searchPlaceholder: "Search...",
        sun: "SUN",
        mon: "MON",
        tue: "TUE",
        wed: "WED",
        thu: "THU",
        fri: "FRI",
        sat: "SAT",
        role: "Orthopedical",
        addDoctor: "Add Doctor",
        doctorUpdated: "Doctor updated successfully!",
        doctorAdded: "New doctor added successfully!",
        doctorDeleted: "Doctor deleted successfully!",
        editDoctor: "Edit Doctor",
        spec_cardiology: "Cardiology",
        spec_dermatology: "Dermatology",
        spec_pediatrics: "Pediatrics",
        spec_orthopedics: "Orthopedics",
        spec_neurology: "Neurology",
        spec_general: "General Practice",
        areYouSure: "Are you sure?",
        deleteConfirmation: "Do you really want to delete this doctor? This process cannot be undone.",
        cancel: "Cancel",
        delete: "Delete",
        editPatient: "Edit Patient",
        patientAdded: "New patient added successfully!",
        patientUpdated: "Patient updated successfully!",
        patientDeleted: "Patient deleted successfully!"
    },
    ar: {
        appTitle: "نظام العيادة",
        loginTitle: "مرحباً بعودتك",
        loginSubtitle: "سجل الدخول للوصول إلى لوحة التحكم",
        emailLabel: "البريد الإلكتروني",
        passwordLabel: "كلمة المرور",
        loginBtn: "تسجيل الدخول",
        dashboard: "لوحة التحكم",
        patients: "المرضى",
        appointments: "المواعيد",
        doctors: "الأطباء",
        settings: "الإعدادات",
        logout: "تسجيل الخروج",
        totalPatients: "إجمالي المرضى",
        todayAppts: "مواعيد اليوم",
        totalDoctors: "إجمالي الأطباء",
        addPatient: "إضافة مريض",
        fullName: "الاسم الكامل",
        age: "العمر",
        phone: "رقم الهاتف",
        gender: "الجنس",
        male: "ذكر",
        female: "أنثى",
        address: "العنوان",
        submit: "إرسال",
        save: "حفظ التغييرات",
        bookAppt: "حجز موعد",
        doctorName: "اسم الطبيب",
        date: "التاريخ",
        time: "الوقت",
        status: "الحالة",
        pending: "قيد الانتظار",
        confirmed: "مؤكد",
        completed: "مكتمل",
        specialty: "التخصص",
        workingDays: "أيام العمل",
        changeUser: "تغيير اسم المستخدم",
        changePass: "تغيير كلمة المرور",
        newUsername: "اسم المستخدم الجديد",
        newPassword: "كلمة المرور الجديدة",
        loginSuccess: "تم تسجيل الدخول بنجاح! جاري التحويل...",
        validationError: "يرجى ملء جميع الحقول.",
        genericSuccess: "تم تنفيذ الإجراء بنجاح!",
        langBtn: "English",
        welcomeDr: "مرحباً، د. سميث",
        recentPatients: "المرضى الجدد",
        patientName: "اسم المريض",
        actions: "الإجراءات",
        view: "عرض",
        incomingPatientHistory: "تاريخ المرضى الواردين",
        weekly: "أسبوعي",
        monthly: "شهري",
        yearly: "سنوي",
        consultation: "استشارة",
        inProgress: "قيد التنفيذ",
        inReview: "قيد المراجعة",
        inPending: "قيد الانتظار",
        goodMorning: "صباح الخير!",
        doctorName2: "د. جون جاكوب",
        specialization: "جراحة العظام",
        bookingRate: "معدل الحجز",
        yourTotalPatient: "إجمالي مرضاك",
        onFriday: "يوم الجمعة",
        bookingHigher: "حجزك أعلى من الأمس",
        yourPatientsToday: "مرضاك اليوم",
        mySchedule: "جدولي",
        searchPlaceholder: "بحث...",
        sun: "الأحد",
        mon: "الاثنين",
        tue: "الثلاثاء",
        wed: "الأربعاء",
        thu: "الخميس",
        fri: "الجمعة",
        sat: "السبت",
        role: "جراحة العظام",
        addDoctor: "إضافة طبيب",
        doctorUpdated: "تم تحديث بيانات الطبيب بنجاح!",
        doctorAdded: "تم إضافة طبيب جديد بنجاح!",
        doctorDeleted: "تم حذف الطبيب بنجاح!",
        editDoctor: "تعديل بيانات الطبيب",
        spec_cardiology: "طب القلب",
        spec_dermatology: "الأمراض الجلدية",
        spec_pediatrics: "طب الأطفال",
        spec_orthopedics: "جراحة العظام",
        spec_neurology: "طب الأعصاب",
        spec_general: "طب عام",
        areYouSure: "هل أنت متأكد؟",
        deleteConfirmation: "هل تريد حقاً حذف هذا الطبيب؟ لا يمكن التراجع عن هذا الإجراء.",
        cancel: "إلغاء",
        delete: "حذف",
        editPatient: "تعديل بيانات المريض",
        patientAdded: "تم إضافة مريض جديد بنجاح!",
        patientUpdated: "تم تحديث بيانات المريض بنجاح!",
        patientDeleted: "تم حذف المريض بنجاح!"
    }
};

class App {
    constructor() {
        this.lang = localStorage.getItem('clinic_lang') || 'en';
        this.theme = localStorage.getItem('clinic_theme') || 'light';
        // Note: init() is called via document.ready at the bottom
    }

    init() {
        this.applyLanguage(this.lang);
        this.applyTheme(this.theme);
        this.bindEvents();
        this.initCharts();
        this.setupGlobalErrorHandlers();

        // Re-apply settings when layout is loaded
        $(document).on('layout-loaded', () => {
            this.applyLanguage(this.lang);
            this.applyTheme(this.theme);
        });
    }

    setupGlobalErrorHandlers() {
        window.addEventListener('error', (e) => {
            console.error('Global error:', e.error);
            this.showAlert('An unexpected error occurred. Please try again.', 'danger');
        });

        window.addEventListener('unhandledrejection', (e) => {
            console.error('Unhandled promise rejection:', e.reason);
            this.showAlert('An operation failed. Please try again.', 'danger');
            e.preventDefault();
        });
    }

    initCharts() {
        const $ctx = $('#bookingChart');
        if ($ctx.length && typeof Chart !== 'undefined') {
            new Chart($ctx[0], {
                type: 'bar',
                data: {
                    labels: ['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT'],
                    datasets: [{
                        label: 'Patients',
                        data: [30, 45, 40, 50, 42, 85, 25],
                        backgroundColor: '#2dd4bf',
                        borderRadius: 50,
                        barThickness: 12,
                        hoverBackgroundColor: '#00f2fe'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: { backgroundColor: 'rgba(47, 65, 86, 0.9)', padding: 12, cornerRadius: 8 }
                    },
                    scales: {
                        y: { display: false, grid: { display: false } },
                        x: { grid: { display: false }, ticks: { color: '#94a3b8', font: { family: "'Inter', sans-serif" } } }
                    },
                    animation: { duration: 2000, easing: 'easeOutQuart' }
                }
            });
        }
    }

    bindEvents() {
        // Use delegated events for elements that might be re-injected (Header/Sidebar)

        // Language Toggle
        $(document).on('click', '#langToggle', (e) => {
            this.toggleLanguage();
        });

        // Theme Toggle
        $(document).on('click', '#themeToggle', (e) => {
            this.toggleTheme();
        });

        // Logout
        $(document).on('click', '#logoutBtn', (e) => {
            e.preventDefault();
            this.logout();
        });

        // Sidebar Toggle
        $(document).on('click', '#sidebarToggle', (e) => {
            $('.sidebar').toggleClass('active');
        });

        // Login Form
        $(document).on('submit', '#loginForm', (e) => this.handleLogin(e));

        // Generic Forms (excluding login and doctor form which has its own handler)
        $(document).on('submit', 'form:not(#loginForm):not(#doctorForm)', (e) => this.handleFormSubmit(e));
    }

    toggleLanguage() {
        this.lang = this.lang === 'en' ? 'ar' : 'en';
        localStorage.setItem('clinic_lang', this.lang);
        this.applyLanguage(this.lang);
    }

    toggleTheme() {
        this.theme = this.theme === 'light' ? 'dark' : 'light';
        localStorage.setItem('clinic_theme', this.theme);
        this.applyTheme(this.theme);
    }

    applyTheme(theme) {
        $('html').attr('data-theme', theme);
        const $btn = $('#themeToggle');
        if ($btn.length) {
            $btn.html(theme === 'dark' ? '<i class="fas fa-sun text-warning"></i>' : '<i class="fas fa-moon"></i>');
        }
    }

    applyLanguage(lang) {
        $('html').attr('lang', lang);
        $('html').attr('dir', lang === 'ar' ? 'rtl' : 'ltr');

        $('[data-i18n]').each(function () {
            const $el = $(this);
            const key = $el.data('i18n'); // Use .data() or .attr()
            // To be safe regarding dynamic updates, .attr() is better if data() caches
            const attrKey = $el.attr('data-i18n');

            if (translations[lang] && translations[lang][attrKey]) {
                const text = translations[lang][attrKey];

                if ($el.is('input') || $el.is('textarea')) {
                    $el.attr('placeholder', text);
                } else {
                    // Check if element has children (like icons)
                    // If it has children and text nodes, replace text nodes?
                    // Original code: if children > 0 logic.
                    // jQuery approach:
                    if ($el.children().length > 0) {
                        // Find text node?
                        // Simple approach: clone children, set text, append children? No, order matters.
                        // Or just set text content of the last text node?
                        // Let's replicate original logic safely.
                        // "if (el.children.length > 0 && el.lastChild.nodeType === 3)"

                        // In jQuery:
                        const contents = $el.contents();
                        const lastNode = contents.last()[0];
                        if (lastNode && lastNode.nodeType === 3) {
                            lastNode.textContent = text;
                        } else {
                            // Maybe just overwrite if structure is simple
                            // For buttons with icons: <i ></i> Text
                            // The text is a text node.
                            // Let's assume text is the last child or simply append if needed.
                            // Safest: Remove text nodes, keep elements?
                            // Let's trust the original logic's intent: replace the visible text part.

                            // Harder to do generically in jQuery one-liner.
                            // Let's use vanilla inside the loop for this specific DOM node manipulation
                            // since jQuery `.text()` wipes children.
                            const el = this;
                            if (el.children.length > 0) {
                                // Iterate nodes to find text?
                                // Or just use the original specific logic
                                let hasText = false;
                                for (let i = 0; i < el.childNodes.length; i++) {
                                    if (el.childNodes[i].nodeType === 3 && el.childNodes[i].nodeValue.trim().length > 0) {
                                        el.childNodes[i].nodeValue = " " + text; // Add space
                                        hasText = true;
                                        break;
                                    }
                                }
                                if (!hasText) {
                                    // If no text node found, maybe append?
                                    // For now, let's fall back to original logic check
                                    if (el.lastChild && el.lastChild.nodeType === 3) {
                                        el.lastChild.textContent = text;
                                    }
                                }
                            } else {
                                $el.text(text);
                            }
                        }
                    } else {
                        $el.text(text);
                    }
                }
            }
        });

        $('[data-i18n-placeholder]').each(function () {
            const $el = $(this);
            const key = $el.attr('data-i18n-placeholder');
            if (translations[lang][key]) {
                $el.attr('placeholder', translations[lang][key]);
            }
        });

        $('#langToggleText').text(translations[lang].langBtn);
    }

    handleLogin(e) {
        e.preventDefault();
        const email = $('#email').val();
        const password = $('#password').val();

        if (email && password) {
            const $btn = $(e.target).find('button');
            const originalText = $btn.text();
            $btn.html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Loading...').prop('disabled', true);

            setTimeout(() => {
                this.showAlert(translations[this.lang].loginSuccess, 'success');
                setTimeout(() => {
                    window.location.href = 'dashboard.html';
                }, 1000);
            }, 1000);
        } else {
            this.showAlert(translations[this.lang].validationError, 'danger');
        }
    }

    handleFormSubmit(e) {
        e.preventDefault();
        const $form = $(e.target);
        const $inputs = $form.find('input, select, textarea');
        let isValid = true;

        $inputs.each(function () {
            const $input = $(this);
            if ($input.prop('required') && !$input.val()) {
                isValid = false;
                $input.addClass('is-invalid');
            } else {
                $input.removeClass('is-invalid');
            }
        });

        if (isValid) {
            const $btn = $form.find('button[type="submit"]');
            const originalText = $btn.text();
            $btn.html('<span class="spinner-border spinner-border-sm"></span>').prop('disabled', true);

            setTimeout(() => {
                this.showAlert(translations[this.lang].genericSuccess, 'success');
                $form[0].reset();
                $btn.text(originalText).prop('disabled', false);
            }, 1000);
        } else {
            this.showAlert(translations[this.lang].validationError, 'danger');
        }
    }

    logout() {
        window.location.href = 'index.html';
    }

    showAlert(message, type) {
        const $alert = $('<div>')
            .addClass(`alert alert-${type} custom-alert show`)
            .text(message)
            .appendTo('body')
            .show();

        setTimeout(() => {
            $alert.fadeOut(300, function () { $(this).remove(); });
        }, 3000);
    }
}

// Initialize App
const app = new App();
$(document).ready(() => {
    app.init();
});
