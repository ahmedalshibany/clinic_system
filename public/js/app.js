const translations = {
    en: {
        appTitle: "Clinic System",
        loginTitle: "Welcome Back",
        loginSubtitle: "Sign in to access your dashboard",
        usernameLabel: "Username",
        usernamePlaceholder: "Enter your username",
        passwordLabel: "Password",
        loginBtn: "Login",
        dashboard: "Dashboard",
        patients: "Patients",
        appointments: "Appointments",
        doctors: "Doctors",
        services: "Services",
        reports: "Reports",
        users: "Users",
        settings: "Settings",
        logout: "Logout",
        totalPatients: "Total Patients",
        todayAppts: "Today's Appointments",
        totalDoctors: "Total Doctors",
        addPatient: "Add Patient",
        fullName: "Full Name",
        age: "Age",
        phone: "Phone Number",
        gender: "Gender",
        male: "Male",
        female: "Female",
        address: "Address",
        submit: "Submit",
        save: "Save Changes",
        bookAppt: "Book Appointment",
        doctorName: "Doctor Name",
        date: "Date",
        time: "Time",
        status: "Status",
        pending: "Pending",
        confirmed: "Confirmed",
        completed: "Completed",
        specialty: "Specialty",
        workingDays: "Working Days",
        changeUser: "Change Username",
        changePass: "Change Password",
        newUsername: "New Username",
        newPassword: "New Password",
        loginSuccess: "Login Successful! Redirecting...",
        validationError: "Please fill in all fields.",
        genericSuccess: "Action completed successfully!",
        langBtn: "العربية",
        welcomeDr: "Welcome, Dr. Smith",
        recentPatients: "Recent Patients",
        patientName: "Patient Name",
        actions: "Actions",
        view: "View",
        incomingPatientHistory: "Incoming Patient History",
        weekly: "Weekly",
        monthly: "Monthly",
        yearly: "Yearly",
        consultation: "CONSULTATION",
        inProgress: "IN PROGRESS",
        inReview: "IN REVIEW",
        inPending: "IN PENDING",
        goodMorning: "Good Morning!",
        doctorName2: "Dr. John Jacob",
        specialization: "Orthopedical",
        bookingRate: "Booking Rate",
        yourTotalPatient: "Your Total Patient",
        onFriday: "on Friday",
        bookingHigher: "Your booking is higher than yesterday",
        yourPatientsToday: "Your Patients Today",
        mySchedule: "My Schedule",
        searchPlaceholder: "Search...",
        sun: "SUN",
        mon: "MON",
        tue: "TUE",
        wed: "WED",
        thu: "THU",
        fri: "FRI",
        sat: "SAT",
        role: "Role",
        addDoctor: "Add Doctor",
        doctorUpdated: "Doctor updated successfully!",
        doctorAdded: "New doctor added successfully!",
        doctorDeleted: "Doctor deleted successfully!",
        editDoctor: "Edit Doctor",
        spec_cardiology: "Cardiology",
        spec_dermatology: "Dermatology",
        spec_pediatrics: "Pediatrics",
        spec_orthopedics: "Orthopedics",
        spec_neurology: "Neurology",
        spec_general: "General Practice",
        areYouSure: "Are you sure?",
        deleteConfirmation: "Do you really want to delete this doctor? This process cannot be undone.",
        deletePatientConfirmation: "Do you really want to delete this patient? This process cannot be undone.",
        cancel: "Cancel",
        delete: "Delete",
        editPatient: "Edit Patient",
        patientAdded: "New patient added successfully!",
        patientUpdated: "Patient updated successfully!",
        patientDeleted: "Patient deleted successfully!",
        searchPatients: "Search patients...",
        previous: "Previous",
        next: "Next",
        noPatients: "No patients yet",
        searchDoctors: "Search doctors...",
        noDoctors: "No doctors yet",
        all: "All Status",
        cancelled: "Cancelled",
        type: "Type",
        noData: "No appointments found",
        edit: "Edit",
        searchAppointments: "Search appointments...",
        showing: "Showing",
        of: "of",
        appointmentsLabel: "appointments",
        appointmentBooked: "Appointment booked successfully!",
        appointmentUpdated: "Appointment updated successfully!",
        appointmentCancelled: "Appointment cancelled successfully!",
        selectPatientDoctor: "Please select a valid patient and doctor from the list.",
        deleteAppointmentConfirmation: "Do you really want to cancel this appointment?",
        editAppointment: "Edit Appointment",
        noAppointments: "No appointments yet",
        unknownPatient: "Unknown Patient",
        unknownDoctor: "Unknown Doctor",
        typeConsultation: "Consultation",
        typeCheckup: "Checkup",
        typeFollowUp: "Follow-up",
        typeEmergency: "Emergency",
        searchPatientPlaceholder: "Type to search patient...",
        searchDoctorPlaceholder: "Type to search doctor...",
        noMatchesFound: "No matches found",
        // Dashboard translations
        welcomeBack: "Welcome Back,",
        doctor: "Doctor",
        dashboardSubtitle: "Here's what's happening with your clinic today",
        statusOverview: "Status Overview",
        appointmentDistribution: "Appointment distribution",
        total: "Total",
        weeklyTrend: "Weekly Trend",
        last7days: "Last 7 days performance",
        live: "Live",
        recentActivity: "Recent Activity",
        latestAppointments: "Latest appointments in your clinic",
        viewAll: "View All",
        // Time filter translations
        filterBy: "Filter by:",
        allTime: "All Time",
        thisWeek: "This Week",
        today: "Today",
        // Patient history translations
        patientHistory: "Patient History",
        patientHistory: "Patient History",
        noAppointmentsForPatient: "No appointment history for this patient",

        // Users & Services & Settings
        userManagement: "User Management",
        searchUsers: "Search users...",
        allRoles: "All Roles",
        admin: "Administrator",
        receptionist: "Receptionist",
        active: "Active",
        inactive: "Inactive",
        activeAccount: "Active Account",
        addUser: "Add User",
        editUser: "Edit User",
        saveUser: "Save User",
        noUsers: "No users found",
        username: "Username",
        email: "Email",
        confirmPassword: "Confirm Password",

        clinicServices: "Clinic Services",
        addService: "Add Service",
        editService: "Edit Service",
        saveService: "Save Service",
        updateService: "Update Service",
        searchServices: "Search services...",
        allCategories: "All Categories",
        catConsultation: "Consultation",
        catProcedure: "Procedure",
        catLab: "Lab",
        catImaging: "Imaging",
        catOther: "Other",
        catOther: "Other",
        serviceCode: "Service Code",
        name: "Name",
        category: "Category",
        nameEn: "Name (English)",
        nameAr: "Name (Arabic)",
        price: "Price",
        activeService: "Active Service",
        noServices: "No services found",

        settingsTitle: "Settings & Configuration",
        settingsSubtitle: "Manage clinic details, system preferences, and other configurations.",
        clinicInfo: "Clinic Info",
        clinicInfoDesc: "Logo, Address, Contacts",
        systemPref: "System",
        systemPrefDesc: "Language, Time, Currency",
        apptSettings: "Appointments",
        apptSettingsDesc: "Slots, Buffers, Rules",
        invSettings: "Invoices",
        invSettingsDesc: "Tax, Prefixes, Terms",
        clinicInfoSection: "Clinic Information",
        clinicLogo: "Clinic Logo",
        logoDimensions: "Recommended size: 300x100px. Max size: 2MB.",
        clinicNameEn: "Clinic Name (English)",
        clinicNameAr: "Clinic Name (Arabic)",
        taxNumber: "Tax Registration Number",
        website: "Website",
        systemPrefSection: "System Preferences",
        defaultLang: "Default Language",
        english: "English",
        arabic: "Arabic",
        timezone: "Timezone",
        dateFormat: "Date Format",
        timeFormat: "Time Format",
        currencyCode: "Currency Code",
        currencySymbol: "Currency Symbol",
        apptSettingsSection: "Appointment Settings",
        slotDuration: "Default Slot Duration (Minutes)",
        bufferTime: "Buffer Between Appointments",
        none: "None",
        advanceBooking: "Advance Booking Days",
        advanceBookingDesc: "How many days in advance can a patient book?",
        allowSameDay: "Allow Same-Day Booking",
        invConfigSection: "Invoice Configuration",
        invPrefix: "Invoice Number Prefix",
        taxRate: "Default Tax Rate (%)",
        taxRateWarning: "The tax rate must be between 0 and 100.",
        dueDays: "Default Due Days",
        paymentTerms: "Default Payment Terms",
        bankDetails: "Bank Details / Payment Instructions",
        saveChanges: "Save Changes",

        // Invoices & Reports
        billingAndInvoices: "Billing & Invoices",
        createInvoice: "Create Invoice",
        searchInvoice: "Search Invoice #",
        allStatus: "All Status",
        draft: "Draft",
        sent: "Sent",
        paid: "Paid",
        partial: "Partial",
        overdue: "Overdue",
        cancelled: "Cancelled",
        fromDate: "From Date",
        toDate: "To Date",
        filter: "Filter",
        invoiceNum: "Invoice #",
        patient: "Patient",
        date: "Date",
        total: "Total",
        paidAmount: "Paid",
        balance: "Balance",
        status: "Status",
        actions: "Actions",
        noInvoices: "No invoices found.",

        reportsDashboard: "Reports Dashboard",
        revenueToday: "Today's Revenue",
        revenueMonth: "Month Revenue",
        totalPatients: "Total Patients",
        newThisMonth: "new this month",
        outstanding: "Outstanding",
        invoicesOverdue: "invoices overdue/sent",
        thisWeek: "This Week",
        thisMonth: "This Month",
        thisYear: "This Year",
        financialReports: "Financial Reports",
        revenueReport: "Revenue Report",
        revenueReportDesc: "Detailed breakdown of income over time.",
        viewReport: "View Report",
        incomeByDoctor: "Income by Doctor",
        incomeByDoctorDesc: "Earnings performance per practitioner.",
        salesByService: "Sales by Service",
        salesByServiceDesc: "Top performing clinic services.",
        outstandingReport: "Outstanding",
        outstandingReportDesc: "Unpaid invoices and debts.",
        operationalReports: "Operational Reports",
        patientDemographics: "Patient Demographics",
        patientDemographicsDesc: "Age, gender, and registration trends.",
        appointmentsReport: "Appointments",
        appointmentsReportDesc: "Status summaries and no-show rates.",

        // Missing Keys Added via Audit
        showing: "Showing",
        of: "of",
        patientsLabel: "patients",
        doctorsLabel: "doctors",
        clickToAddPatient: "Click 'Add Patient' to get started!",
        clickToAddDoctor: "Click 'Add Doctor' to get started!",
        clickToBookAppt: "Click 'Book Appointment' to get started!",
        viewProfile: "View Profile",
        manageSchedule: "Manage Schedule",
    },
    ar: {
        appTitle: "نظام العيادة",
        loginTitle: "مرحباً بعودتك",
        loginSubtitle: "سجل الدخول للوصول إلى لوحة التحكم",
        usernameLabel: "اسم المستخدم",
        usernamePlaceholder: "أدخل اسم المستخدم",
        passwordLabel: "كلمة المرور",
        loginBtn: "تسجيل الدخول",
        dashboard: "لوحة التحكم",
        patients: "المرضى",
        appointments: "المواعيد",
        doctors: "الأطباء",
        services: "الخدمات",
        reports: "التقارير",
        users: "المستخدمين",
        settings: "الإعدادات",
        logout: "تسجيل الخروج",
        totalPatients: "إجمالي المرضى",
        todayAppts: "مواعيد اليوم",
        totalDoctors: "إجمالي الأطباء",
        addPatient: "إضافة مريض",
        fullName: "الاسم الكامل",
        age: "العمر",
        phone: "رقم الهاتف",
        gender: "الجنس",
        male: "ذكر",
        female: "أنثى",
        address: "العنوان",
        submit: "إرسال",
        save: "حفظ التغييرات",
        bookAppt: "حجز موعد",
        doctorName: "اسم الطبيب",
        date: "التاريخ",
        time: "الوقت",
        status: "الحالة",
        pending: "قيد الانتظار",
        confirmed: "مؤكد",
        completed: "مكتمل",
        specialty: "التخصص",
        workingDays: "أيام العمل",
        changeUser: "تغيير اسم المستخدم",
        changePass: "تغيير كلمة المرور",
        newUsername: "اسم المستخدم الجديد",
        newPassword: "كلمة المرور الجديدة",
        loginSuccess: "تم تسجيل الدخول بنجاح! جاري التحويل...",
        validationError: "يرجى ملء جميع الحقول.",
        genericSuccess: "تم تنفيذ الإجراء بنجاح!",
        langBtn: "English",
        welcomeDr: "مرحباً، د. سميث",
        recentPatients: "المرضى الجدد",
        patientName: "اسم المريض",
        actions: "الإجراءات",
        view: "عرض",
        incomingPatientHistory: "تاريخ المرضى الواردين",
        weekly: "أسبوعي",
        monthly: "شهري",
        yearly: "سنوي",
        consultation: "استشارة",
        inProgress: "قيد التنفيذ",
        inReview: "قيد المراجعة",
        inPending: "قيد الانتظار",
        goodMorning: "صباح الخير!",
        doctorName2: "د. جون جاكوب",
        specialization: "جراحة العظام",
        bookingRate: "معدل الحجز",
        yourTotalPatient: "إجمالي مرضاك",
        onFriday: "يوم الجمعة",
        bookingHigher: "حجزك أعلى من الأمس",
        yourPatientsToday: "مرضاك اليوم",
        mySchedule: "جدولي",
        searchPlaceholder: "بحث...",
        sun: "الأحد",
        mon: "الاثنين",
        tue: "الثلاثاء",
        wed: "الأربعاء",
        thu: "الخميس",
        fri: "الجمعة",
        sat: "السبت",
        role: "الدور",
        addDoctor: "إضافة طبيب",
        doctorUpdated: "تم تحديث بيانات الطبيب بنجاح!",
        doctorAdded: "تم إضافة طبيب جديد بنجاح!",
        doctorDeleted: "تم حذف الطبيب بنجاح!",
        editDoctor: "تعديل بيانات الطبيب",
        spec_cardiology: "طب القلب",
        spec_dermatology: "الأمراض الجلدية",
        spec_pediatrics: "طب الأطفال",
        spec_orthopedics: "جراحة العظام",
        spec_neurology: "طب الأعصاب",
        spec_general: "طب عام",
        areYouSure: "هل أنت متأكد؟",
        deleteConfirmation: "هل تريد حقاً حذف هذا الطبيب؟ لا يمكن التراجع عن هذا الإجراء.",
        deletePatientConfirmation: "هل تريد حقاً حذف هذا المريض؟ لا يمكن التراجع عن هذا الإجراء.",
        cancel: "إلغاء",
        delete: "حذف",
        editPatient: "تعديل بيانات المريض",
        patientAdded: "تم إضافة مريض جديد بنجاح!",
        patientUpdated: "تم تحديث بيانات المريض بنجاح!",
        patientDeleted: "تم حذف المريض بنجاح!",
        searchPatients: "البحث عن المرضى...",
        previous: "السابق",
        next: "التالي",
        noPatients: "لا يوجد مرضى بعد",
        searchDoctors: "البحث عن الأطباء...",
        noDoctors: "لا يوجد أطباء بعد",
        all: "جميع الحالات",
        cancelled: "ملغي",
        type: "النوع",
        noData: "لا توجد مواعيد",
        edit: "تعديل",
        searchAppointments: "البحث عن المواعيد...",
        showing: "عرض",
        of: "من",
        appointmentsLabel: "مواعيد",
        appointmentBooked: "تم حجز الموعد بنجاح!",
        appointmentUpdated: "تم تحديث الموعد بنجاح!",
        appointmentCancelled: "تم إلغاء الموعد بنجاح!",
        selectPatientDoctor: "يرجى اختيار مريض وطبيب صالحين من القائمة.",
        deleteAppointmentConfirmation: "هل تريد حقاً إلغاء هذا الموعد؟",
        editAppointment: "تعديل الموعد",
        noAppointments: "لا توجد مواعيد بعد",
        unknownPatient: "مريض غير معروف",
        unknownDoctor: "طبيب غير معروف",
        typeConsultation: "استشارة",
        typeCheckup: "فحص",
        typeFollowUp: "متابعة",
        typeEmergency: "طوارئ",
        searchPatientPlaceholder: "اكتب للبحث عن مريض...",
        searchDoctorPlaceholder: "اكتب للبحث عن طبيب...",
        noMatchesFound: "لم يتم العثور على نتائج",
        // Dashboard translations
        welcomeBack: "مرحباً بعودتك،",
        doctor: "دكتور",
        dashboardSubtitle: "إليك ما يحدث في عيادتك اليوم",
        statusOverview: "نظرة عامة على الحالة",
        appointmentDistribution: "توزيع المواعيد",
        total: "الإجمالي",
        weeklyTrend: "الاتجاه الأسبوعي",
        last7days: "أداء آخر 7 أيام",
        live: "مباشر",
        recentActivity: "النشاط الأخير",
        latestAppointments: "أحدث المواعيد في عيادتك",
        viewAll: "عرض الكل",
        // Time filter translations
        filterBy: "تصفية حسب:",
        allTime: "كل الوقت",
        thisWeek: "هذا الأسبوع",
        today: "اليوم",
        // Patient history translations
        patientHistory: "سجل المريض",
        patientHistory: "سجل المريض",
        noAppointmentsForPatient: "لا يوجد سجل مواعيد لهذا المريض",

        // Users & Services & Settings
        userManagement: "إدارة المستخدمين",
        searchUsers: "البحث عن المستخدمين...",
        allRoles: "جميع الأدوار",
        admin: "مسؤول النظام",
        receptionist: "موظف استقبال",
        active: "نشط",
        inactive: "غير نشط",
        activeAccount: "حساب نشط",
        addUser: "إضافة مستخدم",
        editUser: "تعديل المستخدم",
        saveUser: "حفظ المستخدم",
        noUsers: "لم يتم العثور على مستخدمين",
        username: "اسم المستخدم",
        email: "البريد الإلكتروني",
        confirmPassword: "تأكيد كلمة المرور",

        clinicServices: "خدمات العيادة",
        addService: "إضافة خدمة",
        editService: "تعديل خدمة",
        saveService: "حفظ الخدمة",
        updateService: "تحديث الخدمة",
        searchServices: "البحث في الخدمات...",
        allCategories: "جميع الفئات",
        catConsultation: "استشارة",
        catProcedure: "إجراء طبي",
        catLab: "مختبر",
        catImaging: "أشعة",
        catOther: "أخرى",
        catOther: "أخرى",
        serviceCode: "كود الخدمة",
        name: "الاسم",
        category: "الفئة",
        nameEn: "الاسم (إنجليزي)",
        nameAr: "الاسم (عربي)",
        price: "السعر",
        activeService: "خدمة نشطة",
        noServices: "لا توجد خدمات",

        settingsTitle: "الإعدادات والتكوين",
        settingsSubtitle: "إدارة تفاصيل العيادة، تفضيلات النظام، وتكوينات أخرى.",
        clinicInfo: "معلومات العيادة",
        clinicInfoDesc: "الشعار، العنوان، جهات الاتصال",
        systemPref: "النظام",
        systemPrefDesc: "اللغة، الوقت، العملة",
        apptSettings: "المواعيد",
        apptSettingsDesc: "الفتحات، الفواصل، القواعد",
        invSettings: "الفواتير",
        invSettingsDesc: "الضريبة، البادئات، الشروط",
        clinicInfoSection: "معلومات العيادة",
        clinicLogo: "شعار العيادة",
        logoDimensions: "الحجم الموصى به: 300x100 بكسل. الحد الأقصى: 2 ميجابايت.",
        clinicNameEn: "اسم العيادة (إنجليزي)",
        clinicNameAr: "اسم العيادة (عربي)",
        taxNumber: "رقم التسجيل الضريبي",
        website: "الموقع الإلكتروني",
        systemPrefSection: "تفضيلات النظام",
        defaultLang: "اللغة الافتراضية",
        english: "الإنجليزية",
        arabic: "العربية",
        timezone: "المنطقة الزمنية",
        dateFormat: "تنسيق التاريخ",
        timeFormat: "تنسيق الوقت",
        currencyCode: "رمز العملة",
        currencySymbol: "رمز العملة (مثل $)",
        apptSettingsSection: "إعدادات المواعيد",
        slotDuration: "مدة الموعد الافتراضية (دقائق)",
        bufferTime: "فترة الراحة بين المواعيد",
        none: "لا يوجد",
        advanceBooking: "أيام الحجز المسبق",
        advanceBookingDesc: "كم يوماً مقدماً يمكن للمريض الحجز؟",
        allowSameDay: "السماح بالحجز في نفس اليوم",
        invConfigSection: "تكوين الفواتير",
        invPrefix: "بادئة رقم الفاتورة",
        taxRate: "معدل الضريبة الافتراضي (%)",
        taxRateWarning: "يجب أن يكون معدل الضريبة بين 0 و 100.",
        dueDays: "أيام الاستحقاق الافتراضية",
        paymentTerms: "شروط الدفع الافتراضية",
        bankDetails: "التفاصيل البنكية / تعليمات الدفع",
        saveChanges: "حفظ التغييرات",

        // Invoices & Reports
        billingAndInvoices: "الفواتير والمحاسبة",
        createInvoice: "إنشاء فاتورة",
        searchInvoice: "بحث برقم الفاتورة",
        allStatus: "جميع الحالات",
        draft: "مسودة",
        sent: "مرسلة",
        paid: "مدفوعة",
        partial: "مدفوعة جزئياً",
        overdue: "متأخرة",
        cancelled: "ملغاة",
        fromDate: "من تاريخ",
        toDate: "إلى تاريخ",
        filter: "تصفية",
        invoiceNum: "رقم الفاتورة",
        patient: "المريض",
        date: "التاريخ",
        total: "الإجمالي",
        paidAmount: "المدفوع",
        balance: "المتبقي",
        status: "الحالة",
        actions: "الإجراءات",
        noInvoices: "لم يتم العثور على فواتير",

        reportsDashboard: "لوحة تحكم التقارير",
        revenueToday: "إيرادات اليوم",
        revenueMonth: "إيرادات الشهر",
        totalPatients: "إجمالي المرضى",
        newThisMonth: "جديد هذا الشهر",
        outstanding: "مستحقات",
        invoicesOverdue: "فواتير متأخرة/مرسلة",
        thisWeek: "هذا الأسبوع",
        thisMonth: "هذا الشهر",
        thisYear: "هذا العام",
        financialReports: "التقارير المالية",
        revenueReport: "تقرير الإيرادات",
        revenueReportDesc: "تفصيل الدخل مع مرور الوقت.",
        viewReport: "عرض التقرير",
        incomeByDoctor: "الدخل حسب الطبيب",
        incomeByDoctorDesc: "أداء الأرباح لكل ممارس.",
        salesByService: "المبيعات حسب الخدمة",
        salesByServiceDesc: "الخدمات الأكثر أداءً.",
        outstandingReport: "المستحقات",
        outstandingReportDesc: "الفواتير غير المدفوعة والديون.",
        operationalReports: "التقارير التشغيلية",
        patientDemographics: "ديموغرافيا المرضى",
        patientDemographicsDesc: "العمر، الجنس، واتجاهات التسجيل.",
        appointmentsReport: "المواعيد",
        appointmentsReportDesc: "ملخصات الحالة ومعدلات التغيب.",

        // Missing Keys Added via Audit
        showing: "عرض",
        of: "من",
        patientsLabel: "مرضى",
        doctorsLabel: "أطباء",
        clickToAddPatient: "انقر على 'إضافة مريض' للبدء!",
        clickToAddDoctor: "انقر على 'إضافة طبيب' للبدء!",
        clickToBookAppt: "انقر على 'حجز موعد' للبدء!",
        viewProfile: "عرض الملف الشخصي",
        manageSchedule: "إدارة الجدول",
    }
};

class App {
    constructor() {
        this.lang = localStorage.getItem('clinic_lang') || 'en';
        this.theme = localStorage.getItem('clinic_theme') || 'light';
    }

    init() {
        this.applyLanguage(this.lang);
        this.applyTheme(this.theme);
        this.bindEvents();
        this.initCharts();
        this.setupGlobalErrorHandlers();

        $(document).on('layout-loaded', () => {
            this.applyLanguage(this.lang);
            this.applyTheme(this.theme);
        });
    }

    setupGlobalErrorHandlers() {
        window.addEventListener('error', (e) => {
            console.error('Global error:', e.error);
            this.showAlert('An unexpected error occurred. Please try again.', 'danger');
        });

        window.addEventListener('unhandledrejection', (e) => {
            console.error('Unhandled promise rejection:', e.reason);
            this.showAlert('An operation failed. Please try again.', 'danger');
            e.preventDefault();
        });
    }

    initCharts() {
        const $ctx = $('#bookingChart');
        if ($ctx.length && typeof Chart !== 'undefined') {
            new Chart($ctx[0], {
                type: 'bar',
                data: {
                    labels: ['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT'],
                    datasets: [{
                        label: 'Patients',
                        data: [30, 45, 40, 50, 42, 85, 25],
                        backgroundColor: '#2dd4bf',
                        borderRadius: 50,
                        barThickness: 12,
                        hoverBackgroundColor: '#00f2fe'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: { backgroundColor: 'rgba(47, 65, 86, 0.9)', padding: 12, cornerRadius: 8 }
                    },
                    scales: {
                        y: { display: false, grid: { display: false } },
                        x: { grid: { display: false }, ticks: { color: '#94a3b8', font: { family: "'Inter', sans-serif" } } }
                    },
                    animation: { duration: 2000, easing: 'easeOutQuart' }
                }
            });
        }
    }

    bindEvents() {
        $(document).on('click', '#langToggle', (e) => {
            this.toggleLanguage();
        });

        $(document).on('click', '#themeToggle', (e) => {
            this.toggleTheme();
        });

        $(document).on('click', '#logoutBtn', (e) => {
            e.preventDefault();
            this.logout();
        });

        $(document).on('click', '#sidebarToggle', (e) => {
            $('.sidebar').toggleClass('active');
        });

        $(document).on('submit', '#loginForm', (e) => this.handleLogin(e));

        $(document).on('submit', 'form:not(#loginForm):not(#doctorForm):not(#patientForm)', (e) => this.handleFormSubmit(e));
    }

    toggleLanguage() {
        this.lang = this.lang === 'en' ? 'ar' : 'en';
        localStorage.setItem('clinic_lang', this.lang);
        this.applyLanguage(this.lang);
    }

    toggleTheme() {
        this.theme = this.theme === 'light' ? 'dark' : 'light';
        localStorage.setItem('clinic_theme', this.theme);
        this.applyTheme(this.theme);
    }

    applyTheme(theme) {
        $('html').attr('data-theme', theme);
        const $btn = $('#themeToggle');
        if ($btn.length) {
            $btn.html(theme === 'dark' ? '<i class="fas fa-sun text-warning"></i>' : '<i class="fas fa-moon"></i>');
        }
    }

    applyLanguage(lang) {
        $('html').attr('lang', lang);
        $('html').attr('dir', lang === 'ar' ? 'rtl' : 'ltr');

        $('[data-i18n]').each(function () {
            const $el = $(this);
            const key = $el.data('i18n');
            const attrKey = $el.attr('data-i18n');

            if (translations[lang] && translations[lang][attrKey]) {
                const text = translations[lang][attrKey];

                if ($el.is('input') || $el.is('textarea')) {
                    $el.attr('placeholder', text);
                } else {
                    if ($el.children().length > 0) {
                        const contents = $el.contents();
                        const lastNode = contents.last()[0];
                        if (lastNode && lastNode.nodeType === 3) {
                            lastNode.textContent = text;
                        } else {
                            const el = this;
                            if (el.children.length > 0) {
                                let hasText = false;
                                for (let i = 0; i < el.childNodes.length; i++) {
                                    if (el.childNodes[i].nodeType === 3 && el.childNodes[i].nodeValue.trim().length > 0) {
                                        el.childNodes[i].nodeValue = " " + text;
                                        hasText = true;
                                        break;
                                    }
                                }
                                if (!hasText) {
                                    if (el.lastChild && el.lastChild.nodeType === 3) {
                                        el.lastChild.textContent = text;
                                    }
                                }
                            } else {
                                $el.text(text);
                            }
                        }
                    } else {
                        $el.text(text);
                    }
                }
            }
        });

        $('[data-i18n-placeholder]').each(function () {
            const $el = $(this);
            const key = $el.attr('data-i18n-placeholder');
            if (translations[lang][key]) {
                $el.attr('placeholder', translations[lang][key]);
            }
        });

        $('[data-i18n-title]').each(function () {
            const $el = $(this);
            const key = $el.attr('data-i18n-title');
            if (translations[lang][key]) {
                $el.attr('title', translations[lang][key]);
            }
        });

        $('#langToggleText').text(translations[lang].langBtn);
    }

    handleLogin(e) {
        e.preventDefault();
        const username = $('#username').val();
        const password = $('#password').val();

        if (username && password) {
            const $btn = $(e.target).find('button');
            const originalText = $btn.text();
            $btn.html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Loading...').prop('disabled', true);

            setTimeout(() => {
                this.showAlert(translations[this.lang].loginSuccess, 'success');
                setTimeout(() => {
                    window.location.href = 'dashboard.html';
                }, 1000);
            }, 1000);
        } else {
            this.showAlert(translations[this.lang].validationError, 'danger');
        }
    }

    handleFormSubmit(e) {
        e.preventDefault();
        const $form = $(e.target);
        const $inputs = $form.find('input, select, textarea');
        let isValid = true;

        $inputs.each(function () {
            const $input = $(this);
            if ($input.prop('required') && !$input.val()) {
                isValid = false;
                $input.addClass('is-invalid');
            } else {
                $input.removeClass('is-invalid');
            }
        });

        if (isValid) {
            const $btn = $form.find('button[type="submit"]');
            const originalText = $btn.text();
            $btn.html('<span class="spinner-border spinner-border-sm"></span>').prop('disabled', true);

            setTimeout(() => {
                this.showAlert(translations[this.lang].genericSuccess, 'success');
                $form[0].reset();
                $btn.text(originalText).prop('disabled', false);
            }, 1000);
        } else {
            this.showAlert(translations[this.lang].validationError, 'danger');
        }
    }

    logout() {
        window.location.href = 'index.html';
    }

    showAlert(message, type) {
        if (typeof toast !== 'undefined') {
            toast.show(message, type);
        } else {
            const $alert = $('<div>')
                .addClass(`alert alert-${type} custom-alert show`)
                .text(message)
                .appendTo('body')
                .show();

            setTimeout(() => {
                $alert.fadeOut(300, function () { $(this).remove(); });
            }, 3000);
        }
    }
}

const app = new App();
$(document).ready(() => {
    app.init();
});

class ToastSystem {
    constructor() {
        this.container = null;
        this.init();
    }

    init() {
        if (!document.querySelector('.toast-container')) {
            this.container = document.createElement('div');
            this.container.className = 'toast-container';
            document.body.appendChild(this.container);
        } else {
            this.container = document.querySelector('.toast-container');
        }
    }

    show(message, type = 'info', title = null) {
        if (!this.container) this.init();

        const icons = {
            success: 'fa-check-circle',
            error: 'fa-exclamation-circle',
            warning: 'fa-exclamation-triangle',
            info: 'fa-info-circle'
        };

        const titles = {
            success: 'Success',
            error: 'Error',
            warning: 'Warning',
            info: 'Information'
        };

        if (typeof translations !== 'undefined' && app && app.lang) {
        }

        const icon = icons[type] || icons.info;
        const displayTitle = title || titles[type] || 'Notification';

        const toast = document.createElement('div');
        toast.className = `toast-notification ${type}`;

        toast.innerHTML = `
            <div class="toast-icon">
                <i class="fas ${icon}"></i>
            </div>
            <div class="toast-content">
                <div class="toast-title">${displayTitle}</div>
                <div class="toast-message">${message}</div>
            </div>
            <div class="toast-close" onclick="this.parentElement.remove()">
                <i class="fas fa-times"></i>
            </div>
            <div class="toast-progress">
                <div class="toast-progress-bar"></div>
            </div>
        `;

        this.container.appendChild(toast);

        setTimeout(() => {
            if (toast.parentElement) {
                toast.classList.add('closing');
                toast.addEventListener('animationend', () => {
                    if (toast.parentElement) toast.remove();
                });
            }
        }, 4000);
    }

    success(message) { this.show(message, 'success'); }
    error(message) { this.show(message, 'error'); }
    warning(message) { this.show(message, 'warning'); }
    info(message) { this.show(message, 'info'); }
}

window.toast = new ToastSystem();
